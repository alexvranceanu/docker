{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Docker Swarm Cluster Template. Currently creates a single master swarm node.",
  "Parameters": {
    "KeyName": {
      "Description": "Name of an existing EC2 KeyPair to enable SSH access to the instance",
      "Type": "AWS::EC2::KeyPair::KeyName",
      "ConstraintDescription": "must be the name of an existing EC2 KeyPair."
    },
    "NumberOfSwarmNodes": {
      "Description": "Number of Swarm Nodes (default: 1)",
      "Type": "Number",
      "Default": 1,
      "MinValue": 1,
      "MaxValue": 4
    },
    "NumberOfSwarmManagers": {
      "Description": "One Swarm Manager will always exist. This field refers to additional Swarm Managers (default: 0)",
      "Type": "Number",
      "Default": 0,
      "MinValue": 0,
      "MaxValue": 4
    }
  },
  "Mappings": {
    "Region2Examples": {
      "us-east-1": {
        "Examples": "https://s3.amazonaws.com/cloudformation-examples-us-east-1"
      },
      "us-west-2": {
        "Examples": "https://s3-us-west-2.amazonaws.com/cloudformation-examples-us-west-2"
      },
      "us-west-1": {
        "Examples": "https://s3-us-west-1.amazonaws.com/cloudformation-examples-us-west-1"
      },
      "eu-west-1": {
        "Examples": "https://s3-eu-west-1.amazonaws.com/cloudformation-examples-eu-west-1"
      },
      "eu-central-1": {
        "Examples": "https://s3-eu-central-1.amazonaws.com/cloudformation-examples-eu-central-1"
      },
      "ap-southeast-1": {
        "Examples": "https://s3-ap-southeast-1.amazonaws.com/cloudformation-examples-ap-southeast-1"
      },
      "ap-northeast-1": {
        "Examples": "https://s3-ap-northeast-1.amazonaws.com/cloudformation-examples-ap-northeast-1"
      },
      "ap-northeast-2": {
        "Examples": "https://s3-ap-northeast-2.amazonaws.com/cloudformation-examples-ap-northeast-2"
      },
      "ap-southeast-2": {
        "Examples": "https://s3-ap-southeast-2.amazonaws.com/cloudformation-examples-ap-southeast-2"
      },
      "ap-south-1": {
        "Examples": "https://s3-ap-south-1.amazonaws.com/cloudformation-examples-ap-south-1"
      },
      "sa-east-1": {
        "Examples": "https://s3-sa-east-1.amazonaws.com/cloudformation-examples-sa-east-1"
      },
      "cn-north-1": {
        "Examples": "https://s3.cn-north-1.amazonaws.com.cn/cloudformation-examples-cn-north-1"
      }
    },
    "AWSInstanceType2Arch": {
      "t1.micro": {
        "Arch": "PV64"
      },
      "t2.nano": {
        "Arch": "HVM64"
      },
      "t2.micro": {
        "Arch": "HVM64"
      },
      "t2.small": {
        "Arch": "HVM64"
      },
      "t2.medium": {
        "Arch": "HVM64"
      },
      "t2.large": {
        "Arch": "HVM64"
      },
      "m1.small": {
        "Arch": "PV64"
      },
      "m1.medium": {
        "Arch": "PV64"
      },
      "m1.large": {
        "Arch": "PV64"
      },
      "m1.xlarge": {
        "Arch": "PV64"
      },
      "m2.xlarge": {
        "Arch": "PV64"
      },
      "m2.2xlarge": {
        "Arch": "PV64"
      },
      "m2.4xlarge": {
        "Arch": "PV64"
      },
      "m3.medium": {
        "Arch": "HVM64"
      },
      "m3.large": {
        "Arch": "HVM64"
      },
      "m3.xlarge": {
        "Arch": "HVM64"
      },
      "m3.2xlarge": {
        "Arch": "HVM64"
      },
      "m4.large": {
        "Arch": "HVM64"
      },
      "m4.xlarge": {
        "Arch": "HVM64"
      },
      "m4.2xlarge": {
        "Arch": "HVM64"
      },
      "m4.4xlarge": {
        "Arch": "HVM64"
      },
      "m4.10xlarge": {
        "Arch": "HVM64"
      },
      "c1.medium": {
        "Arch": "PV64"
      },
      "c1.xlarge": {
        "Arch": "PV64"
      },
      "c3.large": {
        "Arch": "HVM64"
      },
      "c3.xlarge": {
        "Arch": "HVM64"
      },
      "c3.2xlarge": {
        "Arch": "HVM64"
      },
      "c3.4xlarge": {
        "Arch": "HVM64"
      },
      "c3.8xlarge": {
        "Arch": "HVM64"
      },
      "c4.large": {
        "Arch": "HVM64"
      },
      "c4.xlarge": {
        "Arch": "HVM64"
      },
      "c4.2xlarge": {
        "Arch": "HVM64"
      },
      "c4.4xlarge": {
        "Arch": "HVM64"
      },
      "c4.8xlarge": {
        "Arch": "HVM64"
      },
      "g2.2xlarge": {
        "Arch": "HVMG2"
      },
      "g2.8xlarge": {
        "Arch": "HVMG2"
      },
      "r3.large": {
        "Arch": "HVM64"
      },
      "r3.xlarge": {
        "Arch": "HVM64"
      },
      "r3.2xlarge": {
        "Arch": "HVM64"
      },
      "r3.4xlarge": {
        "Arch": "HVM64"
      },
      "r3.8xlarge": {
        "Arch": "HVM64"
      },
      "i2.xlarge": {
        "Arch": "HVM64"
      },
      "i2.2xlarge": {
        "Arch": "HVM64"
      },
      "i2.4xlarge": {
        "Arch": "HVM64"
      },
      "i2.8xlarge": {
        "Arch": "HVM64"
      },
      "d2.xlarge": {
        "Arch": "HVM64"
      },
      "d2.2xlarge": {
        "Arch": "HVM64"
      },
      "d2.4xlarge": {
        "Arch": "HVM64"
      },
      "d2.8xlarge": {
        "Arch": "HVM64"
      },
      "hi1.4xlarge": {
        "Arch": "HVM64"
      },
      "hs1.8xlarge": {
        "Arch": "HVM64"
      },
      "cr1.8xlarge": {
        "Arch": "HVM64"
      },
      "cc2.8xlarge": {
        "Arch": "HVM64"
      }
    },
    "AWSInstanceType2NATArch": {
      "t1.micro": {
        "Arch": "NATPV64"
      },
      "t2.nano": {
        "Arch": "NATHVM64"
      },
      "t2.micro": {
        "Arch": "NATHVM64"
      },
      "t2.small": {
        "Arch": "NATHVM64"
      },
      "t2.medium": {
        "Arch": "NATHVM64"
      },
      "t2.large": {
        "Arch": "NATHVM64"
      },
      "m1.small": {
        "Arch": "NATPV64"
      },
      "m1.medium": {
        "Arch": "NATPV64"
      },
      "m1.large": {
        "Arch": "NATPV64"
      },
      "m1.xlarge": {
        "Arch": "NATPV64"
      },
      "m2.xlarge": {
        "Arch": "NATPV64"
      },
      "m2.2xlarge": {
        "Arch": "NATPV64"
      },
      "m2.4xlarge": {
        "Arch": "NATPV64"
      },
      "m3.medium": {
        "Arch": "NATHVM64"
      },
      "m3.large": {
        "Arch": "NATHVM64"
      },
      "m3.xlarge": {
        "Arch": "NATHVM64"
      },
      "m3.2xlarge": {
        "Arch": "NATHVM64"
      },
      "m4.large": {
        "Arch": "NATHVM64"
      },
      "m4.xlarge": {
        "Arch": "NATHVM64"
      },
      "m4.2xlarge": {
        "Arch": "NATHVM64"
      },
      "m4.4xlarge": {
        "Arch": "NATHVM64"
      },
      "m4.10xlarge": {
        "Arch": "NATHVM64"
      },
      "c1.medium": {
        "Arch": "NATPV64"
      },
      "c1.xlarge": {
        "Arch": "NATPV64"
      },
      "c3.large": {
        "Arch": "NATHVM64"
      },
      "c3.xlarge": {
        "Arch": "NATHVM64"
      },
      "c3.2xlarge": {
        "Arch": "NATHVM64"
      },
      "c3.4xlarge": {
        "Arch": "NATHVM64"
      },
      "c3.8xlarge": {
        "Arch": "NATHVM64"
      },
      "c4.large": {
        "Arch": "NATHVM64"
      },
      "c4.xlarge": {
        "Arch": "NATHVM64"
      },
      "c4.2xlarge": {
        "Arch": "NATHVM64"
      },
      "c4.4xlarge": {
        "Arch": "NATHVM64"
      },
      "c4.8xlarge": {
        "Arch": "NATHVM64"
      },
      "g2.2xlarge": {
        "Arch": "NATHVMG2"
      },
      "g2.8xlarge": {
        "Arch": "NATHVMG2"
      },
      "r3.large": {
        "Arch": "NATHVM64"
      },
      "r3.xlarge": {
        "Arch": "NATHVM64"
      },
      "r3.2xlarge": {
        "Arch": "NATHVM64"
      },
      "r3.4xlarge": {
        "Arch": "NATHVM64"
      },
      "r3.8xlarge": {
        "Arch": "NATHVM64"
      },
      "i2.xlarge": {
        "Arch": "NATHVM64"
      },
      "i2.2xlarge": {
        "Arch": "NATHVM64"
      },
      "i2.4xlarge": {
        "Arch": "NATHVM64"
      },
      "i2.8xlarge": {
        "Arch": "NATHVM64"
      },
      "d2.xlarge": {
        "Arch": "NATHVM64"
      },
      "d2.2xlarge": {
        "Arch": "NATHVM64"
      },
      "d2.4xlarge": {
        "Arch": "NATHVM64"
      },
      "d2.8xlarge": {
        "Arch": "NATHVM64"
      },
      "hi1.4xlarge": {
        "Arch": "NATHVM64"
      },
      "hs1.8xlarge": {
        "Arch": "NATHVM64"
      },
      "cr1.8xlarge": {
        "Arch": "NATHVM64"
      },
      "cc2.8xlarge": {
        "Arch": "NATHVM64"
      }
    },
    "AWSRegionArch2AMI": {
      "us-east-1": {
        "PV64": "ami-2a69aa47",
        "HVM64": "ami-6869aa05",
        "HVMG2": "ami-2e5e9c43"
      },
      "us-west-2": {
        "PV64": "ami-7f77b31f",
        "HVM64": "ami-7172b611",
        "HVMG2": "ami-83b770e3"
      },
      "us-west-1": {
        "PV64": "ami-a2490dc2",
        "HVM64": "ami-31490d51",
        "HVMG2": "ami-fd76329d"
      },
      "eu-west-1": {
        "PV64": "ami-4cdd453f",
        "HVM64": "ami-f9dd458a",
        "HVMG2": "ami-b9bd25ca"
      },
      "eu-central-1": {
        "PV64": "ami-6527cf0a",
        "HVM64": "ami-ea26ce85",
        "HVMG2": "ami-7f04ec10"
      },
      "ap-northeast-1": {
        "PV64": "ami-3e42b65f",
        "HVM64": "ami-374db956",
        "HVMG2": "ami-e0ee1981"
      },
      "ap-northeast-2": {
        "PV64": "NOT_SUPPORTED",
        "HVM64": "ami-2b408b45",
        "HVMG2": "NOT_SUPPORTED"
      },
      "ap-southeast-1": {
        "PV64": "ami-df9e4cbc",
        "HVM64": "ami-a59b49c6",
        "HVMG2": "ami-0cb5676f"
      },
      "ap-southeast-2": {
        "PV64": "ami-63351d00",
        "HVM64": "ami-dc361ebf",
        "HVMG2": "ami-a71c34c4"
      },
      "ap-south-1": {
        "PV64": "NOT_SUPPORTED",
        "HVM64": "ami-ffbdd790",
        "HVMG2": "ami-f5b2d89a"
      },
      "sa-east-1": {
        "PV64": "ami-1ad34676",
        "HVM64": "ami-6dd04501",
        "HVMG2": "NOT_SUPPORTED"
      },
      "cn-north-1": {
        "PV64": "ami-77559f1a",
        "HVM64": "ami-8e6aa0e3",
        "HVMG2": "NOT_SUPPORTED"
      }
    }
  },
  "Resources": {
    "VPC": {
      "Type": "AWS::EC2::VPC",
      "Properties": {
        "CidrBlock": "10.0.0.0/16",
        "Tags": [
          {
            "Key": "Application",
            "Value": {
              "Ref": "AWS::StackId"
            }
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "f7a95dec-24f7-4bd1-a6aa-b06a1b858eb6"
        }
      }
    },
    "Subnet": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": {
          "Ref": "VPC"
        },
        "CidrBlock": "10.0.0.0/24",
        "Tags": [
          {
            "Key": "Swarm",
            "Value": {
              "Ref": "AWS::StackId"
            }
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "79532a3b-2b19-4d32-972a-03d549d4c273"
        }
      }
    },
    "InternetGateway": {
      "Type": "AWS::EC2::InternetGateway",
      "Properties": {
        "Tags": [
          {
            "Key": "Application",
            "Value": {
              "Ref": "AWS::StackId"
            }
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "dc8637f5-b7e3-4e8f-93d8-a9488b85e302"
        }
      }
    },
    "AttachGateway": {
      "Type": "AWS::EC2::VPCGatewayAttachment",
      "Properties": {
        "VpcId": {
          "Ref": "VPC"
        },
        "InternetGatewayId": {
          "Ref": "InternetGateway"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "e8bddf72-0ac5-4aad-8f1c-09e6cb90b368"
        }
      }
    },
    "RouteTable": {
      "Type": "AWS::EC2::RouteTable",
      "Properties": {
        "VpcId": {
          "Ref": "VPC"
        },
        "Tags": [
          {
            "Key": "Application",
            "Value": {
              "Ref": "AWS::StackId"
            }
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "489ef81b-843c-45d2-85c3-fde60f092ef5"
        }
      }
    },
    "Route": {
      "Type": "AWS::EC2::Route",
      "DependsOn": "AttachGateway",
      "Properties": {
        "RouteTableId": {
          "Ref": "RouteTable"
        },
        "DestinationCidrBlock": "0.0.0.0/0",
        "GatewayId": {
          "Ref": "InternetGateway"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "0f3746f7-8101-4a56-8bcd-b95ca51d1eaa"
        }
      }
    },
    "SubnetRouteTableAssociation": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": {
          "Ref": "Subnet"
        },
        "RouteTableId": {
          "Ref": "RouteTable"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "4f4229bf-ae7c-4a67-b634-842d09aa604d"
        }
      }
    },
    "NetworkAcl": {
      "Type": "AWS::EC2::NetworkAcl",
      "Properties": {
        "VpcId": {
          "Ref": "VPC"
        },
        "Tags": [
          {
            "Key": "Application",
            "Value": {
              "Ref": "AWS::StackId"
            }
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "d94e48a6-0e78-4dc1-bdea-023fd38faa78"
        }
      }
    },
    "InboundSSHNetworkAclEntry": {
      "Type": "AWS::EC2::NetworkAclEntry",
      "Properties": {
        "NetworkAclId": {
          "Ref": "NetworkAcl"
        },
        "RuleNumber": "101",
        "Protocol": "6",
        "RuleAction": "allow",
        "Egress": "false",
        "CidrBlock": "0.0.0.0/0",
        "PortRange": {
          "From": "22",
          "To": "22"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "61c4f89e-d17c-4678-bd9e-d59adb924090"
        }
      }
    },
    "InboundResponsePortsNetworkAclEntry": {
      "Type": "AWS::EC2::NetworkAclEntry",
      "Properties": {
        "NetworkAclId": {
          "Ref": "NetworkAcl"
        },
        "RuleNumber": "102",
        "Protocol": "6",
        "RuleAction": "allow",
        "Egress": "false",
        "CidrBlock": "0.0.0.0/0",
        "PortRange": {
          "From": "1024",
          "To": "65535"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "65d96b24-b5cf-4931-8f3f-f6faf7998c01"
        }
      }
    },
    "OutBoundResponsePortsNetworkAclEntry": {
      "Type": "AWS::EC2::NetworkAclEntry",
      "Properties": {
        "NetworkAclId": {
          "Ref": "NetworkAcl"
        },
        "RuleNumber": "102",
        "Protocol": "-1",
        "RuleAction": "allow",
        "Egress": "true",
        "CidrBlock": "0.0.0.0/0"
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "0476859a-84fa-476d-b379-0b2d93836142"
        }
      }
    },
    "SubnetNetworkAclAssociation": {
      "Type": "AWS::EC2::SubnetNetworkAclAssociation",
      "Properties": {
        "SubnetId": {
          "Ref": "Subnet"
        },
        "NetworkAclId": {
          "Ref": "NetworkAcl"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "a5c5fb18-7deb-40e0-bea0-37d9fd31d659"
        }
      }
    },
    "InstanceSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "VpcId": {
          "Ref": "VPC"
        },
        "GroupDescription": "Docker Swarm connections",
        "SecurityGroupEgress": [
          {
            "IpProtocol": "-1",
            "CidrIp": "0.0.0.0/0"
          }
        ],
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "2377",
            "ToPort": "2377",
            "CidrIp": "10.0.0.0/24"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "4789",
            "ToPort": "4789",
            "CidrIp": "10.0.0.0/16"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "22",
            "ToPort": "22",
            "CidrIp": "0.0.0.0/0"
          },
          {
            "IpProtocol": "udp",
            "FromPort": "7946",
            "ToPort": "7946",
            "CidrIp": "10.0.0.0/16"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "7946",
            "ToPort": "7946",
            "CidrIp": "10.0.0.0/16"
          },
          {
            "IpProtocol": "udp",
            "FromPort": "2049",
            "ToPort": "2049",
            "CidrIp": "10.0.0.0/16"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "111",
            "ToPort": "111",
            "CidrIp": "10.0.0.0/16"
          },
          {
            "IpProtocol": "udp",
            "FromPort": "4789",
            "ToPort": "4789",
            "CidrIp": "10.0.0.0/16"
          },
          {
            "IpProtocol": "udp",
            "FromPort": "111",
            "ToPort": "111",
            "CidrIp": "10.0.0.0/16"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "2049",
            "ToPort": "2049",
            "CidrIp": "10.0.0.0/16"
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "592a6e2e-a61c-4ced-9b97-84235a5fe8e3"
        }
      }
    },
    "SwarmLordInstance": {
      "Type": "AWS::EC2::Instance",
      "Metadata": {
        "Comment": "Install a Docker Swarm initial master",
        "AWS::CloudFormation::Designer": {
          "id": "de3b3559-e774-4a41-ba45-99338ab0315a"
        }
      },
      "Properties": {
        "Monitoring": "false",
        "ImageId": "ami-d2c924b2",
        "InstanceType": "t2.micro",
        "KeyName": {
          "Ref": "KeyName"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "AWS::StackName"
                  },
                  "-",
                  "Lord"
                ]
              ]
            }
          }
        ],
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "",
              [
                "#!/bin/bash\n",
                "tee /etc/yum.repos.d/docker.repo <<-EOF\n",
                "[dockerrepo]\n",
                "name=Docker Repository\n",
                "baseurl=https://yum.dockerproject.org/repo/main/centos/7\n",
                "enabled=1\n",
                "gpgcheck=1\n",
                "gpgkey=https://yum.dockerproject.org/gpg\n",
                "EOF\n",
                "\n",
                "mkdir /tokens\n",
                "echo '/tokens *(ro)' > /etc/exports\n",
                "systemctl start nfs\n",
                "\n",
                "yum -y install docker-engine\n",
                "\n",
                "service docker start\n",
                "\n",
                "docker swarm init\n",
                "\n",
                "echo -n `docker swarm join-token -q worker` > /tokens/worker\n",
                "echo -n `docker swarm join-token -q manager` > /tokens/manager\n"
              ]
            ]
          }
        },
        "NetworkInterfaces": [
          {
            "DeleteOnTermination": "true",
            "Description": "Primary network interface",
            "DeviceIndex": 0,
            "PrivateIpAddresses": [
              {
                "PrivateIpAddress": "10.0.0.100",
                "Primary": "true"
              }
            ],
            "AssociatePublicIpAddress": "true",
            "GroupSet": [
              {
                "Ref": "InstanceSecurityGroup"
              }
            ],
            "SubnetId": {
              "Ref": "Subnet"
            }
          }
        ]
      }
    },
    "NodeLaunchConfiguration": {
      "Type": "AWS::AutoScaling::LaunchConfiguration",
      "Properties": {
        "ImageId": "ami-d2c924b2",
        "InstanceType": "t2.micro",
        "KeyName": {
          "Ref": "KeyName"
        },
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "",
              [
                "#!/bin/bash\n",
                "tee /etc/yum.repos.d/docker.repo <<-EOF\n",
                "[dockerrepo]\n",
                "name=Docker Repository\n",
                "baseurl=https://yum.dockerproject.org/repo/main/centos/7\n",
                "enabled=1\n",
                "gpgcheck=1\n",
                "gpgkey=https://yum.dockerproject.org/gpg\n",
                "EOF\n",
                "\n",
                "mkdir /tokens\n",
                "mount -t nfs 10.0.0.100:/tokens /tokens\n",
                "\n",
                "yum -y install docker-engine\n",
                "\n",
                "service docker start\n",
                "\n",
                "docker swarm join --token `cat /tokens/worker` 10.0.0.100:2377\n",
                "\n",
                "umount /tokens\n"
              ]
            ]
          }
        },
        "AssociatePublicIpAddress": "true",
        "SecurityGroups": [
          {
            "Ref": "InstanceSecurityGroup"
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "593f7138-e9c3-4200-be94-0f05547a0951"
        }
      }
    },
    "NodeAutoScalingGroup": {
      "Type": "AWS::AutoScaling::AutoScalingGroup",
      "Properties": {
        "VPCZoneIdentifier": [
          {
            "Ref": "Subnet"
          }
        ],
        "LaunchConfigurationName": {
          "Ref": "NodeLaunchConfiguration"
        },
        "MinSize": {
          "Ref": "NumberOfSwarmNodes"
        },
        "MaxSize": "4",
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "AWS::StackName"
                  },
                  "-",
                  "Node"
                ]
              ]
            },
            "PropagateAtLaunch": "true"
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "da606599-3278-49f8-bd04-bb4c7a251bfe"
        }
      },
      "DependsOn": [
        "SwarmLordInstance"
      ],
      "UpdatePolicy": {
        "AutoScalingRollingUpdate": {
          "MaxBatchSize": "1",
          "MinInstancesInService": "1",
          "PauseTime": "PT5M",
          "WaitOnResourceSignals": "true"
        }
      }
    },
    "ManagerAutoScaling": {
      "Type": "AWS::AutoScaling::AutoScalingGroup",
      "Properties": {
        "VPCZoneIdentifier": [
          {
            "Ref": "Subnet"
          }
        ],
        "LaunchConfigurationName": {
          "Ref": "ManagerLaunchConfiguration"
        },
        "MinSize": {
          "Ref": "NumberOfSwarmManagers"
        },
        "MaxSize": "4",
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "AWS::StackName"
                  },
                  "-",
                  "Manager"
                ]
              ]
            },
            "PropagateAtLaunch": "true"
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "54df3969-155c-4994-b7fc-5aea159ccce7"
        }
      },
      "UpdatePolicy": {
        "AutoScalingRollingUpdate": {
          "MaxBatchSize": "1",
          "MinInstancesInService": "1",
          "PauseTime": "PT5M",
          "WaitOnResourceSignals": "true"
        }
      },
      "DependsOn": [
        "SwarmLordInstance"
      ]
    },
    "ManagerLaunchConfiguration": {
      "Type": "AWS::AutoScaling::LaunchConfiguration",
      "Properties": {
        "ImageId": "ami-d2c924b2",
        "InstanceType": "t2.micro",
        "KeyName": {
          "Ref": "KeyName"
        },
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "",
              [
                "#!/bin/bash\n",
                "tee /etc/yum.repos.d/docker.repo <<-EOF\n",
                "[dockerrepo]\n",
                "name=Docker Repository\n",
                "baseurl=https://yum.dockerproject.org/repo/main/centos/7\n",
                "enabled=1\n",
                "gpgcheck=1\n",
                "gpgkey=https://yum.dockerproject.org/gpg\n",
                "EOF\n",
                "\n",
                "mkdir /tokens\n",
                "mount -t nfs 10.0.0.100:/tokens /tokens\n",
                "\n",
                "yum -y install docker-engine\n",
                "\n",
                "service docker start\n",
                "\n",
                "docker swarm join --token `cat /tokens/manager` 10.0.0.100:2377\n",
                "\n",
                "umount /tokens\n"
              ]
            ]
          }
        },
        "AssociatePublicIpAddress": "true",
        "SecurityGroups": [
          {
            "Ref": "InstanceSecurityGroup"
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "1ecd7a3e-2ff7-4261-bf7b-d0858ee3e378"
        }
      }
    }
  },
  "Outputs": {
    "URL": {
      "Value": {
        "Fn::Join": [
          "",
          [
            "http://",
            {
              "Fn::GetAtt": [
                "SwarmLordInstance",
                "PublicIp"
              ]
            }
          ]
        ]
      },
      "Description": "Newly created application URL"
    }
  },
  "Metadata": {
    "AWS::CloudFormation::Interface": {
      "ParameterGroups": [
        {
          "Label": {
            "default": "Swarm Cluster Configuration"
          },
          "Parameters": [
            "NumberOfSwarmManagers",
            "NumberOfSwarmNodes"
          ]
        }
      ],
      "ParameterLabels": {
        "NumberOfSwarmManagers": {
          "default": "Number of additional Swarm Managers to deploy: "
        },
        "NumberOfSwarmNodes": {
          "default": "Number of Swarm worker Nodes to deploy: "
        },
        "KeyName": {
          "default": "Name of SSH key pair to use on instances: "
        }
      }
    },
    "AWS::CloudFormation::Designer": {
      "dc8637f5-b7e3-4e8f-93d8-a9488b85e302": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 300,
          "y": 520
        },
        "z": 1,
        "embeds": []
      },
      "f7a95dec-24f7-4bd1-a6aa-b06a1b858eb6": {
        "size": {
          "width": 780,
          "height": 690
        },
        "position": {
          "x": 60,
          "y": -200
        },
        "z": 1,
        "embeds": [
          "592a6e2e-a61c-4ced-9b97-84235a5fe8e3",
          "d94e48a6-0e78-4dc1-bdea-023fd38faa78",
          "489ef81b-843c-45d2-85c3-fde60f092ef5",
          "79532a3b-2b19-4d32-972a-03d549d4c273"
        ]
      },
      "592a6e2e-a61c-4ced-9b97-84235a5fe8e3": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 200,
          "y": 40
        },
        "z": 2,
        "parent": "f7a95dec-24f7-4bd1-a6aa-b06a1b858eb6",
        "embeds": []
      },
      "d94e48a6-0e78-4dc1-bdea-023fd38faa78": {
        "size": {
          "width": 320,
          "height": 130
        },
        "position": {
          "x": 90,
          "y": -110
        },
        "z": 2,
        "parent": "f7a95dec-24f7-4bd1-a6aa-b06a1b858eb6",
        "embeds": [
          "0476859a-84fa-476d-b379-0b2d93836142",
          "65d96b24-b5cf-4931-8f3f-f6faf7998c01",
          "61c4f89e-d17c-4678-bd9e-d59adb924090"
        ]
      },
      "0476859a-84fa-476d-b379-0b2d93836142": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 110,
          "y": -80
        },
        "z": 3,
        "parent": "d94e48a6-0e78-4dc1-bdea-023fd38faa78",
        "embeds": []
      },
      "65d96b24-b5cf-4931-8f3f-f6faf7998c01": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 290,
          "y": -80
        },
        "z": 3,
        "parent": "d94e48a6-0e78-4dc1-bdea-023fd38faa78",
        "embeds": []
      },
      "61c4f89e-d17c-4678-bd9e-d59adb924090": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 200,
          "y": -80
        },
        "z": 3,
        "parent": "d94e48a6-0e78-4dc1-bdea-023fd38faa78",
        "embeds": []
      },
      "489ef81b-843c-45d2-85c3-fde60f092ef5": {
        "size": {
          "width": 240,
          "height": 240
        },
        "position": {
          "x": 480,
          "y": 160
        },
        "z": 2,
        "parent": "f7a95dec-24f7-4bd1-a6aa-b06a1b858eb6",
        "embeds": [
          "0f3746f7-8101-4a56-8bcd-b95ca51d1eaa"
        ]
      },
      "e8bddf72-0ac5-4aad-8f1c-09e6cb90b368": {
        "source": {
          "id": "dc8637f5-b7e3-4e8f-93d8-a9488b85e302"
        },
        "target": {
          "id": "f7a95dec-24f7-4bd1-a6aa-b06a1b858eb6"
        },
        "z": 1
      },
      "0f3746f7-8101-4a56-8bcd-b95ca51d1eaa": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 510,
          "y": 220
        },
        "z": 3,
        "parent": "489ef81b-843c-45d2-85c3-fde60f092ef5",
        "embeds": [],
        "references": [
          "dc8637f5-b7e3-4e8f-93d8-a9488b85e302"
        ],
        "dependson": [
          "e8bddf72-0ac5-4aad-8f1c-09e6cb90b368"
        ]
      },
      "79532a3b-2b19-4d32-972a-03d549d4c273": {
        "size": {
          "width": 360,
          "height": 240
        },
        "position": {
          "x": 450,
          "y": -130
        },
        "z": 2,
        "parent": "f7a95dec-24f7-4bd1-a6aa-b06a1b858eb6",
        "embeds": [
          "1ecd7a3e-2ff7-4261-bf7b-d0858ee3e378",
          "593f7138-e9c3-4200-be94-0f05547a0951",
          "de3b3559-e774-4a41-ba45-99338ab0315a",
          "54df3969-155c-4994-b7fc-5aea159ccce7",
          "da606599-3278-49f8-bd04-bb4c7a251bfe"
        ]
      },
      "de3b3559-e774-4a41-ba45-99338ab0315a": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 600,
          "y": 40
        },
        "z": 3,
        "parent": "79532a3b-2b19-4d32-972a-03d549d4c273",
        "embeds": [],
        "ismemberof": [
          "592a6e2e-a61c-4ced-9b97-84235a5fe8e3"
        ],
        "isrelatedto": [
          "592a6e2e-a61c-4ced-9b97-84235a5fe8e3"
        ]
      },
      "a5c5fb18-7deb-40e0-bea0-37d9fd31d659": {
        "source": {
          "id": "d94e48a6-0e78-4dc1-bdea-023fd38faa78"
        },
        "target": {
          "id": "79532a3b-2b19-4d32-972a-03d549d4c273"
        },
        "z": 2
      },
      "4f4229bf-ae7c-4a67-b634-842d09aa604d": {
        "source": {
          "id": "489ef81b-843c-45d2-85c3-fde60f092ef5"
        },
        "target": {
          "id": "79532a3b-2b19-4d32-972a-03d549d4c273"
        },
        "z": 2
      },
      "da606599-3278-49f8-bd04-bb4c7a251bfe": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 650,
          "y": -100
        },
        "z": 3,
        "parent": "79532a3b-2b19-4d32-972a-03d549d4c273",
        "embeds": [],
        "isconnectedto": [
          "79532a3b-2b19-4d32-972a-03d549d4c273"
        ],
        "isassociatedwith": [
          "593f7138-e9c3-4200-be94-0f05547a0951"
        ],
        "dependson": [
          "de3b3559-e774-4a41-ba45-99338ab0315a"
        ]
      },
      "593f7138-e9c3-4200-be94-0f05547a0951": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 730,
          "y": -100
        },
        "z": 3,
        "parent": "79532a3b-2b19-4d32-972a-03d549d4c273",
        "embeds": [],
        "ismemberof": [
          "592a6e2e-a61c-4ced-9b97-84235a5fe8e3"
        ],
        "isrelatedto": [
          "592a6e2e-a61c-4ced-9b97-84235a5fe8e3",
          "79532a3b-2b19-4d32-972a-03d549d4c273"
        ]
      },
      "7d6ca4e4-780e-4fb3-9249-cf997c1b9cef": {
        "source": {
          "id": "da606599-3278-49f8-bd04-bb4c7a251bfe"
        },
        "target": {
          "id": "de3b3559-e774-4a41-ba45-99338ab0315a"
        },
        "z": 4
      },
      "8cc22819-5e71-4655-939d-df30613dea82": {
        "source": {
          "id": "593f7138-e9c3-4200-be94-0f05547a0951"
        },
        "target": {
          "id": "592a6e2e-a61c-4ced-9b97-84235a5fe8e3"
        },
        "z": 4
      },
      "54df3969-155c-4994-b7fc-5aea159ccce7": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 570,
          "y": -100
        },
        "z": 3,
        "parent": "79532a3b-2b19-4d32-972a-03d549d4c273",
        "embeds": [],
        "isconnectedto": [
          "79532a3b-2b19-4d32-972a-03d549d4c273"
        ],
        "isassociatedwith": [
          "593f7138-e9c3-4200-be94-0f05547a0951",
          "1ecd7a3e-2ff7-4261-bf7b-d0858ee3e378"
        ],
        "dependson": [
          "de3b3559-e774-4a41-ba45-99338ab0315a"
        ]
      },
      "1ecd7a3e-2ff7-4261-bf7b-d0858ee3e378": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 490,
          "y": -100
        },
        "z": 3,
        "parent": "79532a3b-2b19-4d32-972a-03d549d4c273",
        "embeds": [],
        "ismemberof": [
          "592a6e2e-a61c-4ced-9b97-84235a5fe8e3"
        ]
      },
      "f69604b6-e33c-4f24-a89c-14ced7514994": {
        "source": {
          "id": "54df3969-155c-4994-b7fc-5aea159ccce7"
        },
        "target": {
          "id": "de3b3559-e774-4a41-ba45-99338ab0315a"
        },
        "z": 4
      }
    }
  }
}
